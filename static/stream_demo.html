<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Broker Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-top: 0;
        }

        h2 {
            color: #666;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        input,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
            font-family: inherit;
            box-sizing: border-box;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .success {
            color: #28a745;
        }

        .error {
            color: #dc3545;
        }

        .info {
            color: #17a2b8;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: 600;
            color: #555;
        }

        .message-item {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }

        .message-id {
            font-weight: bold;
            color: #0056b3;
            font-size: 12px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            flex: 1;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <h1>üîÑ Stream Broker Demo</h1>
    <p>Test the fire-and-forget message handling system with Redis-style streams and consumer groups.</p>

    <div class="grid">
        <div>
            <!-- Producer Section -->
            <div class="container">
                <h2>üì§ Producer</h2>
                <label>Stream Name:</label>
                <input type="text" id="streamName" value="demo-stream" />

                <label>Message Data (JSON):</label>
                <textarea id="messageData" rows="4">{"task": "process_order", "orderId": 12345}</textarea>

                <button onclick="addMessage()">Add Message to Stream</button>
            </div>

            <!-- Consumer Group Setup -->
            <div class="container">
                <h2>üë• Consumer Group Setup</h2>
                <label>Stream Name:</label>
                <input type="text" id="groupStreamName" value="demo-stream" />

                <label>Group Name:</label>
                <input type="text" id="groupName" value="demo-workers" />

                <label>Start Position:</label>
                <select id="startId">
                    <option value="0">From Beginning (0)</option>
                    <option value="$" selected>New Messages Only ($)</option>
                </select>

                <button onclick="createGroup()">Create Consumer Group</button>
            </div>

            <!-- Consumer -->
            <div class="container">
                <h2>üì• Consumer</h2>
                <label>Stream Name:</label>
                <input type="text" id="consumerStreamName" value="demo-stream" />

                <label>Group Name:</label>
                <input type="text" id="consumerGroupName" value="demo-workers" />

                <label>Consumer Name:</label>
                <input type="text" id="consumerName" value="worker-1" />

                <label>Count:</label>
                <input type="number" id="messageCount" value="10" min="1" max="100" />

                <label>Block Time (ms):</label>
                <input type="number" id="blockTime" value="0" min="0" step="1000" />

                <button onclick="readMessages()">Read Messages</button>
                <button onclick="startAutoRead()" id="autoReadBtn">Start Auto-Read</button>
                <button onclick="stopAutoRead()" id="stopReadBtn" disabled>Stop Auto-Read</button>

                <div id="messages" style="margin-top: 15px;"></div>
            </div>
        </div>

        <div>
            <!-- Stream Info -->
            <div class="container">
                <h2>üìä Stream Information</h2>
                <label>Stream Name:</label>
                <input type="text" id="infoStreamName" value="demo-stream" />

                <button onclick="getStreamInfo()">Refresh Info</button>

                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-value" id="streamLength">0</div>
                        <div class="stat-label">Messages</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="groupCount">0</div>
                        <div class="stat-label">Groups</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="pendingCount">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>

                <div id="groupInfo" style="margin-top: 15px;"></div>
            </div>

            <!-- Activity Log -->
            <div class="container">
                <h2>üìù Activity Log</h2>
                <button onclick="clearLog()" style="float: right;">Clear Log</button>
                <div class="log" id="log"></div>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = window.location.origin;
        let autoReadInterval = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info');
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function addMessage() {
            const streamName = document.getElementById('streamName').value;
            const messageData = document.getElementById('messageData').value;

            try {
                const data = JSON.parse(messageData);
                const response = await fetch(`${BASE_URL}/stream/${streamName}/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (response.ok) {
                    log(`‚úì Message added to ${streamName}: ${result.messageId}`, 'success');
                    await getStreamInfo(); // Update stats
                } else {
                    log(`‚úó Error: ${result.error}`, 'error');
                }
            } catch (e) {
                log(`‚úó Error: ${e.message}`, 'error');
            }
        }

        async function createGroup() {
            const streamName = document.getElementById('groupStreamName').value;
            const groupName = document.getElementById('groupName').value;
            const startId = document.getElementById('startId').value;

            try {
                const response = await fetch(`${BASE_URL}/stream/${streamName}/group/${groupName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ startId })
                });

                const result = await response.json();
                if (response.ok) {
                    log(`‚úì Group created: ${groupName} on ${streamName}`, 'success');
                    await getStreamInfo(); // Update stats
                } else {
                    log(`‚úó Error: ${result.error}`, 'error');
                }
            } catch (e) {
                log(`‚úó Error: ${e.message}`, 'error');
            }
        }

        async function readMessages() {
            const streamName = document.getElementById('consumerStreamName').value;
            const groupName = document.getElementById('consumerGroupName').value;
            const consumerName = document.getElementById('consumerName').value;
            const count = document.getElementById('messageCount').value;
            const blockTime = document.getElementById('blockTime').value;

            try {
                const response = await fetch(
                    `${BASE_URL}/stream/${streamName}/group/${groupName}/consumer/${consumerName}?count=${count}&block=${blockTime}`
                );

                const result = await response.json();
                if (response.ok) {
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.innerHTML = '';

                    if (result.messages.length === 0) {
                        log(`‚Ñπ No messages available for ${consumerName}`, 'info');
                        messagesDiv.innerHTML = '<p style="color: #999; text-align: center;">No messages</p>';
                    } else {
                        log(`‚úì Read ${result.messages.length} message(s) for ${consumerName}`, 'success');

                        result.messages.forEach(msg => {
                            const msgDiv = document.createElement('div');
                            msgDiv.className = 'message-item';
                            msgDiv.innerHTML = `
                                <div class="message-id">ID: ${msg.id}</div>
                                <pre style="margin: 5px 0;">${JSON.stringify(msg.data, null, 2)}</pre>
                                <button onclick="acknowledgeMessage('${streamName}', '${groupName}', '${msg.id}')">
                                    Acknowledge
                                </button>
                            `;
                            messagesDiv.appendChild(msgDiv);
                        });
                    }

                    await getStreamInfo(); // Update stats
                } else {
                    log(`‚úó Error: ${result.error}`, 'error');
                }
            } catch (e) {
                log(`‚úó Error: ${e.message}`, 'error');
            }
        }

        async function acknowledgeMessage(streamName, groupName, messageId) {
            try {
                const response = await fetch(`${BASE_URL}/stream/${streamName}/group/${groupName}/ack`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messageIds: [messageId] })
                });

                const result = await response.json();
                if (response.ok) {
                    log(`‚úì Acknowledged message: ${messageId}`, 'success');
                    await readMessages(); // Refresh messages
                } else {
                    log(`‚úó Error: ${result.error}`, 'error');
                }
            } catch (e) {
                log(`‚úó Error: ${e.message}`, 'error');
            }
        }

        async function getStreamInfo() {
            const streamName = document.getElementById('infoStreamName').value ||
                document.getElementById('streamName').value;

            try {
                const response = await fetch(`${BASE_URL}/stream/${streamName}/info`);
                const result = await response.json();

                if (response.ok) {
                    // Update stats
                    document.getElementById('streamLength').textContent = result.length;
                    document.getElementById('groupCount').textContent = result.groups.length;

                    let totalPending = 0;
                    result.groups.forEach(g => totalPending += g.totalPending);
                    document.getElementById('pendingCount').textContent = totalPending;

                    // Display group info
                    const groupInfoDiv = document.getElementById('groupInfo');
                    groupInfoDiv.innerHTML = '<h3>Consumer Groups:</h3>';

                    if (result.groups.length === 0) {
                        groupInfoDiv.innerHTML += '<p style="color: #999;">No consumer groups</p>';
                    } else {
                        result.groups.forEach(group => {
                            const groupDiv = document.createElement('div');
                            groupDiv.style.cssText = 'background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 4px;';

                            let consumersHtml = group.consumers.map(c =>
                                `<li>${c.name}: ${c.pending} pending</li>`
                            ).join('');

                            groupDiv.innerHTML = `
                                <strong>${group.name}</strong>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    Last ID: ${group.lastDeliveredId}<br>
                                    Total Pending: ${group.totalPending}<br>
                                    Consumers: ${group.consumers.length}
                                    ${consumersHtml ? `<ul style="margin: 5px 0;">${consumersHtml}</ul>` : ''}
                                </div>
                            `;
                            groupInfoDiv.appendChild(groupDiv);
                        });
                    }
                } else {
                    log(`‚úó Error getting info: ${result.error}`, 'error');
                }
            } catch (e) {
                log(`‚úó Error: ${e.message}`, 'error');
            }
        }

        function startAutoRead() {
            if (autoReadInterval) return;

            document.getElementById('autoReadBtn').disabled = true;
            document.getElementById('stopReadBtn').disabled = false;

            log('‚ñ∂ Auto-read started (every 2 seconds)', 'info');

            autoReadInterval = setInterval(async () => {
                await readMessages();
            }, 2000);
        }

        function stopAutoRead() {
            if (!autoReadInterval) return;

            clearInterval(autoReadInterval);
            autoReadInterval = null;

            document.getElementById('autoReadBtn').disabled = false;
            document.getElementById('stopReadBtn').disabled = true;

            log('‚è∏ Auto-read stopped', 'info');
        }

        // Quick start guide
        window.addEventListener('load', () => {
            log('=== Stream Broker Demo Ready ===', 'success');
            log('Quick Start:', 'info');
            log('1. Create a consumer group', 'info');
            log('2. Add some messages', 'info');
            log('3. Read messages as a consumer', 'info');
            log('4. Acknowledge processed messages', 'info');
            getStreamInfo();
        });
    </script>
</body>

</html>